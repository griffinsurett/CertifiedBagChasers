---
export interface Props {
  id: string;
  title?: string;
  description?: string;
  className?: string;
  panelClassName?: string;
}

const {
  id,
  title = "",
  description = "",
  className = "",
  panelClassName = "",
} = Astro.props as Props;
---

<div
  id={id}
  data-product-form-modal={id}
  class={`fixed inset-0 z-[9999] hidden ${className}`}
  aria-hidden="true"
>
  <div
    data-product-form-modal-close
    class="absolute inset-0 bg-black/75 backdrop-blur-[2px]"
  ></div>

  <div class="relative h-full w-full flex items-center justify-center p-4">
    <div class={`relative w-full max-w-[580px] max-h-[90vh] overflow-y-auto ${panelClassName}`}>
      <button
        type="button"
        data-product-form-modal-close
        class="absolute right-3 top-3 z-10 inline-flex h-9 w-9 items-center justify-center rounded-full border border-white/20 bg-black/60 text-white transition hover:bg-black/80"
        aria-label="Close form modal"
      >
        <svg viewBox="0 0 24 24" class="h-5 w-5" fill="none" aria-hidden="true">
          <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>
      </button>

      {
        (title || description) && (
          <div class="mb-4 px-2">
            {title && <h2 class="text-2xl md:text-3xl font-extrabold text-white">{title}</h2>}
            {description && <p class="mt-2 text-text-secondary">{description}</p>}
          </div>
        )
      }

      <slot />
    </div>
  </div>
</div>

<script is:inline define:vars={{ id }}>
  (() => {
    const modal = document.querySelector(`[data-product-form-modal="${id}"]`);
    if (!modal || modal.getAttribute("data-modal-ready") === "true") return;

    const closeTargets = Array.from(
      modal.querySelectorAll("[data-product-form-modal-close]")
    );

    const lockBody = () => {
      const current = Number(document.body.dataset.modalCount || "0");
      const next = current + 1;
      document.body.dataset.modalCount = String(next);
      if (next === 1) {
        document.body.dataset.modalOverflow = document.body.style.overflow || "";
        document.body.style.overflow = "hidden";
      }
    };

    const unlockBody = () => {
      const current = Number(document.body.dataset.modalCount || "0");
      const next = Math.max(0, current - 1);
      document.body.dataset.modalCount = String(next);
      if (next === 0) {
        document.body.style.overflow = document.body.dataset.modalOverflow || "";
      }
    };

    const openModal = () => {
      modal.classList.remove("hidden");
      modal.setAttribute("aria-hidden", "false");
      lockBody();
    };

    const closeModal = () => {
      if (modal.classList.contains("hidden")) return;
      modal.classList.add("hidden");
      modal.setAttribute("aria-hidden", "true");
      unlockBody();
    };

    closeTargets.forEach((target) => {
      target.addEventListener("click", closeModal);
    });

    document.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof Element)) return;

      const trigger = target.closest(
        `[data-open-modal="${id}"], a[href="#${id}"]`
      );
      if (!trigger) return;

      event.preventDefault();
      openModal();
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") closeModal();
    });

    modal.setAttribute("data-modal-ready", "true");
  })();
</script>
